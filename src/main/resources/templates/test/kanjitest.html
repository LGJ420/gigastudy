<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>GIGASTUDY</title>
</head>

<body class="m-auto w-[40rem]">
    <header>
        <nav th:fragment="nav">
            <div class="flex items-center justify-between p-3">
                <a class="flex items-center" href="#">
                    <img class="w-10 h-10 object-contain" src="/images/logo.png" alt="Logo">
                    <div class="px-2">
                        GIGASTUDY
                    </div>
                </a>
                <div class="ml-10 mr-auto">
                    <ul class="flex items-center">
                        <li class="px-2">
                            <a href="/kanji">한자</a>
                        </li>
                        <li class="px-2">
                            <a href="/english">영어</a>
                        </li>
                        <li class="px-2">
                            <a href="/save">암기장</a>
                        </li>
                    </ul>
                </div>
                <a href="#">로그인</a>
            </div>
        </nav>
    </header>

    <main class="py-5">

        <section th:fragment="content">
            <h1 class="p-5 text-3xl">한자</h1>
            <div id="cardContainer">
                <div id="wordCard" class="card" onclick="handleClickNext()">
                    <div id="wordDisplay" class="front">
                        <!-- 단어 -->
                    </div>
                    <div id="wordMeaning" class="back">
                        <!-- 의미 -->
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-center h-10 py-10">
                <button class="bg-[#f9f9f9] border rounded-md py-2 px-3 mx-3 hover:opacity-30"
                    onclick="handleClickPre()">이전</button>
                <button class="bg-[#f9f9f9] border rounded-md py-2 px-3 mx-3 hover:opacity-30"
                    onclick="handleClickNext()">다음</button>
                <button class="bg-[#f9f9f9] border rounded-md py-2 px-3 mx-3 hover:opacity-30"
                    onclick="handleClickSave()">저장</button>
                <button class="bg-[#f9f9f9] border rounded-md py-2 px-3 mx-3 hover:opacity-30">섞기</button>
                <button class="bg-[#f9f9f9] border rounded-md py-2 px-3 mx-3 hover:opacity-30">추가</button>
            </div>

            <div id="loadingBarContainer" class="fixed inset-0 flex items-center justify-center bg-white z-50">
                <div class="w-1/2">
                    <div>로딩중입니다...</div>
                    <div class="bg-gray-200 rounded-full">
                        <div id="loadingBar" class="bg-blue-500 h-4 rounded-full w-0"></div>
                    </div>
                </div>
            </div>

        </section>


    </main>


    <style>
        #cardContainer {
            perspective: 60rem;
        }

        .card {
            width: 30rem;
            height: 20rem;
            margin: 0 auto;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .front,
        .back {
            position: absolute;
            width: 90%;
            height: 90%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .back {
            transform: rotateY(-180deg);
        }

        .flipped {
            transform: rotateY(-180deg);
        }

        .fly-off {
            animation: flyOffAnimation 0.5s forwards;
        }

        @keyframes flyOffAnimation {
            from {
                transform: rotateY(-180deg) translateY(0);
                opacity: 1;
            }

            to {
                transform: rotateY(-180deg) translateY(-500px);
                opacity: 0;
            }
        }

        #loadingBar {
            width: 0;
            transition: width 0.5s ease-in-out;
        }

        #loadingBarContainer {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
    </style>

    <script>
        let currentIndex = 0;
        let words = [];
        let turning = false;
        let isAnimating = false;

        // 사이트 초기화
        async function init() {
            try {
                updateLoadingBar(20);

                // currentIndex 불러오기
                const indexResponse = await fetch('/api/userindex?flag=false&type=KANJI', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                currentIndex = await indexResponse.json();
                updateLoadingBar(70); // 첫번째 요청 완료 후 50%로 설정

                // 단어 리스트 불러오기
                const response = await fetch('/api/userword?type=KANJI');
                words = await response.json();
                updateLoadingBar(90); // 두번째 요청 완료 후 80%로 설정

                displayWord();
                updateLoadingBar(100); // 완료 후 100%로 설정

                // 로딩바가 다 채워진 후에만 페이드아웃 시작
                setTimeout(() => {
                    fadeOutLoadingScreen();
                }, 1000); // 1초 동안 로딩바가 채워지는 애니메이션 시간과 맞춤

            } catch (error) {
                console.error('데이터를 불러오는데 실패하였습니다.', error);
            }


            // 단축키 설정
            document.addEventListener('keydown', function (event) {

                // 애니메이션 중이면 단축키 동작 안함
                if (isAnimating) return;

                if (event.key === 'Enter') {
                    handleClickNext();
                } else if (event.key === 'p') {
                    handleClickSave();
                } else if (event.key === 'Backspace') {
                    handleClickPre();
                }
            });
        }

        // 스크린 페이드아웃
        function fadeOutLoadingScreen() {
            const loadingBarContainer = document.getElementById("loadingBarContainer");
            loadingBarContainer.style.opacity = '0'; // 투명하게 설정

            // 페이드아웃 애니메이션이 끝난 후 로딩바를 제거
            setTimeout(() => {
                loadingBarContainer.style.display = 'none'; // 완전히 제거
            }, 500); // 페이드아웃 시간과 맞춤 (0.5초 후에 제거)
        }



        // 로딩바 업데이트
        function updateLoadingBar(percent) {
            const loadingBar = document.getElementById("loadingBar");
            loadingBar.style.width = percent + "%";
        }


        // 인덱스 저장
        async function saveCurrentIndex() {
            try {
                const response = await fetch('/api/userindex', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        flag: false,
                        type: 'KANJI',
                        saveIndex: currentIndex
                    })
                });
                console.log('인덱스가 저장되었습니다.');
            } catch (error) {
                console.error('인덱스 저장에 실패하였습니다.', error);
            }
        }



        // 단어카드 보여주기
        function displayWord() {

            const wordDiv = document.getElementById("wordDisplay");
            const meaningDiv = document.getElementById("wordMeaning");

            if (currentIndex < words.length && currentIndex >= 0) {
                const word = words[currentIndex].wordDTO.word;
                const meaning = words[currentIndex].wordDTO.meaning;

                // 글자 길이에 따라 폰트 크기를 조정
                if (word.length > 10) {
                    wordDiv.style.fontSize = '2rem';
                } else if (word.length > 6) {
                    wordDiv.style.fontSize = '3rem';
                } else if (word.length > 2) {
                    wordDiv.style.fontSize = '5rem';
                } else {
                    wordDiv.style.fontSize = '10rem';
                }

                if (meaning.length > 10) {
                    meaningDiv.style.fontSize = '2rem';
                } else if (meaning.length > 6) {
                    meaningDiv.style.fontSize = '3rem';
                } else {
                    meaningDiv.style.fontSize = '5rem';
                }

                wordDiv.textContent = word;
                meaningDiv.textContent = meaning;

            } else {
                wordDiv.textContent = "더이상 단어가 없습니다.";
                meaningDiv.textContent = "더이상 단어가 없습니다.";
            }
        }


        // 다음 단어로 가기
        function handleClickNext() {
            const card = document.getElementById("wordCard");
            if (currentIndex < words.length) {
                if (turning) {
                    isAnimating = true;
                    const wordDiv = document.getElementById("wordDisplay");
                    wordDiv.textContent = " ";
                    card.classList.add("fly-off");
                    card.addEventListener('animationend', () => {
                        currentIndex++;
                        turning = false;
                        card.classList.remove("fly-off");
                        card.classList.remove("flipped");
                        displayWord();
                        saveCurrentIndex();
                        isAnimating = false;
                    }, { once: true });
                } else {
                    isAnimating = true;
                    card.classList.add("flipped");
                    turning = true;
                    isAnimating = false;
                }
            }
        }


        // 이전 단어로 가기
        function handleClickPre() {
            if (currentIndex > 0) {
                currentIndex--;
                turning = false;
                const card = document.getElementById("wordCard");
                card.classList.remove("flipped");
                card.classList.remove("fly-off");
                displayWord();
                saveCurrentIndex();
            }
        }


        // 암기장에 저장하기
        async function handleClickSave() {
            if (currentIndex < words.length) {
                const wordId = words[currentIndex].wordDTO.id;
                try {
                    await fetch(`/api/userword/${wordId}`, { method: 'POST' });
                    alert('암기장에 저장되었습니다.');
                } catch (error) {
                    console.error('암기장 저장에 실패하였습니다.', error);
                }
            }
        }

        window.onload = init;

    </script>

</body>

</html>